{% extends "base.html" %}
{% block content %}
<h1>Görselleri yükle → DOCX planını indir</h1>
<p class="muted">Drive yok. Görselleri burada ver, sistem her görsel için <b>1 sayfa</b> olacak şekilde
  <b>açıklama → iletişim → 3 hashtag</b> sırasıyla <b>.docx</b> üretir.</p>

<form id="planForm" action="/generate" method="post" enctype="multipart/form-data" class="card">

  <div class="field">
    <label>Dosya adı</label>
    <input type="text" name="doc_name" id="doc_name" required
           value="Instagram_Plani_{{ suggested_name }}">
    <small class="muted">Örn: Kasim_Instagram_Plani_2025</small>
  </div>

  <div class="field">
    <label>İletişim bilgisi</label>
    <input type="text" name="contact_info" id="contact_info" required
           value="📞 0 (242) 000 00 00   🌐 https://example.com">
    <small class="muted">Her sayfada açıklamanın altında yer alır.</small>
  </div>

  <div class="field">
    <label>Görseller (çoklu seçim, max 10)</label>

    <div id="dropzone" class="dropzone" tabindex="0">
      <div class="dz-inner">
        <div class="dz-icon">🖼️</div>
        <div class="dz-text">
          <b>Görselleri sürükleyip bırak</b> veya
          <label for="fileInput" class="linklike">Dosyaları Seç</label>
        </div>
        <div class="dz-hint">PNG, JPG/JPEG, WebP. Büyük görseller otomatik optimize edilir.</div>
      </div>
      <input id="fileInput" type="file" name="files" accept="image/*" multiple hidden>
    </div>

    <div class="dz-status">
      <span id="fileCount">0/10 görsel seçildi</span>
      <span id="totalSize" class="muted">Toplam: 0 MB</span>
    </div>

    <div id="previewGrid" class="file-grid"></div>
    <div id="errorBox" class="alert hidden"></div>
  </div>

  <div class="form-actions">
    <button id="submitBtn" class="btn" type="submit" disabled>Oluştur ve indir (.docx)</button>
    <button id="clearBtn" class="btn btn-secondary" type="button">Temizle</button>
  </div>
</form>

<div class="tips">
  <details>
    <summary>İpucu: Maliyeti düşük tutma</summary>
    <ul>
      <li>Görseller yüklenmeden önce istemci tarafında 1280px JPEG'e sıkıştırılır → küçük istek, hızlı indirme.</li>
      <li>Açıklama + 3 hashtag tek çağrıda üretilir, gereksiz token harcanmaz.</li>
    </ul>
  </details>
</div>

<script>
  (function () {
    const MAX_FILES = 10;

    // === İstemci tarafında JPEG sıkıştırma (1280px) ===
    function compressImage(file, maxEdge = 1280, quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!/^image\//.test(file.type)) return resolve(null);
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let { width: w, height: h } = img;
          const scale = Math.min(maxEdge / Math.max(w, h), 1);
          w = Math.round(w * scale);
          h = Math.round(h * scale);
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          canvas.toBlob(blob => {
            if (!blob) return reject(new Error('Sıkıştırma başarısız'));
            const name = (file.name || 'image').replace(/\.\w+$/, '') + '.jpg';
            const out = new File([blob], name, { type: 'image/jpeg' });
            resolve(out);
          }, 'image/jpeg', quality);
        };
        img.onerror = () => resolve(null);
        const reader = new FileReader();
        reader.onload = e => { img.src = e.target.result; };
        reader.readAsDataURL(file);
      });
    }

    async function compressBatch(files) {
      const out = [];
      for (const f of files) {
        const c = await compressImage(f, 1280, 0.8);
        out.push(c || f);
      }
      return out;
    }

    // === Elemanlar ===
    const form = document.getElementById('planForm');
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const fileCount = document.getElementById('fileCount');
    const totalSize = document.getElementById('totalSize');
    const previewGrid = document.getElementById('previewGrid');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const errorBox = document.getElementById('errorBox');
    const docNameEl = document.getElementById('doc_name');
    const contactEl = document.getElementById('contact_info');

    let currentFiles = [];
    function bytesToMB(b) { return (b / (1024 * 1024)).toFixed(2); }
    function showError(msg) { errorBox.textContent = msg; errorBox.classList.remove('hidden'); }
    function clearError() { errorBox.textContent = ''; errorBox.classList.add('hidden'); }
    function updateStatus() {
      fileCount.textContent = `${currentFiles.length}/${MAX_FILES} görsel seçildi`;
      const totalBytes = currentFiles.reduce((a, f) => a + (f.size || 0), 0);
      totalSize.textContent = 'Toplam: ' + bytesToMB(totalBytes) + ' MB';
      submitBtn.disabled = currentFiles.length === 0 || currentFiles.length > MAX_FILES;
    }
    function clearPreviews() { previewGrid.innerHTML = ''; }
    function makePreview(file, idx) {
      const card = document.createElement('div'); card.className = 'file-card';
      const img = document.createElement('img'); img.alt = file.name; img.loading = 'lazy';
      const reader = new FileReader(); reader.onload = e => { img.src = e.target.result; }; reader.readAsDataURL(file);
      const meta = document.createElement('div'); meta.className = 'file-meta';
      meta.innerHTML = `<div class="name" title="${file.name}">${file.name}</div><div class="size">${bytesToMB(file.size)} MB</div>`;
      const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.className = 'chip'; removeBtn.textContent = 'Kaldır';
      removeBtn.addEventListener('click', () => { currentFiles.splice(idx, 1); renderPreviews(); });
      card.appendChild(img); card.appendChild(meta); card.appendChild(removeBtn); return card;
    }
    function renderPreviews() {
      clearPreviews(); clearError();
      if (currentFiles.length > MAX_FILES) showError(`En fazla ${MAX_FILES} görsel yükleyebilirsiniz.`);
      currentFiles.forEach((f, i) => previewGrid.appendChild(makePreview(f, i)));
      updateStatus();
    }

    // Dosya ekleme → önce sıkıştır, sonra listeye ekle
    async function addFiles(fileList) {
      const imgs = Array.from(fileList || []).filter(f => /^image\//.test(f.type));
      if (!imgs.length) return;
      submitBtn.textContent = 'Görseller hazırlanıyor…'; submitBtn.disabled = true;
      try {
        const compressed = await compressBatch(imgs);
        currentFiles = currentFiles.concat(compressed).slice(0, MAX_FILES);
      } finally {
        submitBtn.textContent = 'Oluştur ve indir (.docx)';
        submitBtn.disabled = currentFiles.length === 0;
      }
      renderPreviews();
    }

    // Dropzone davranışları
    ['dragenter','dragover','dragleave','drop'].forEach(evt => {
      dropzone.a
